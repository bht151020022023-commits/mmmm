<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nh·∫≠t k√Ω ch·∫°y b·ªô Online</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{font-family:Arial;background:linear-gradient(135deg,#4facfe,#00f2fe);margin:0;padding:15px;}
.box{background:white;border-radius:16px;padding:18px;box-shadow:0 8px 20px rgba(0,0,0,0.15);max-width:420px;margin:auto;}
input,button{width:100%;padding:12px;margin:8px 0;border-radius:10px;border:1px solid #ddd;font-size:16px;box-sizing:border-box;}
button{background:#4facfe;color:white;font-weight:bold;}
.dayBar{display:flex;align-items:center;justify-content:space-between;background:#eee;padding:6px 10px;border-radius:12px;margin-bottom:10px;}
.monthNav{display:flex;justify-content:space-between;align-items:center;margin-top:10px;font-weight:bold;}
.sectionBox{margin-top:12px;background:#e6f7ff;padding:10px;border-radius:10px;font-weight:bold;}
.sectionHeader{display:flex;justify-content:space-between;align-items:center;cursor:pointer;}
.sectionContent{display:none;margin-top:6px;}
.progressBarWrap{background:#ddd;height:12px;border-radius:10px;margin-top:6px;overflow:hidden;}
.progressBar{height:100%;background:linear-gradient(90deg,#00c853,#4caf50);width:0%;}
.dots{display:flex;flex-wrap:wrap;gap:10px;margin-top:10px;}
.dayDot{display:flex;flex-direction:column;align-items:center;width:28px;}
.dot{width:18px;height:18px;border-radius:50%;background:#ddd;}
.dayNum{font-size:10px;margin-top:2px;color:#555;}
.dayDetail{margin-top:10px;background:white;padding:8px;border-radius:8px;}
.historyItem{background:#fff;padding:8px;border-radius:8px;margin-top:6px;display:flex;justify-content:space-between;align-items:center;}
.deleteBtn{background:#ff4d4d;border:none;color:white;border-radius:50%;width:26px;height:26px;}
</style>
</head>

<body>
<div class="box">
<h2>üèÉ Nh·∫≠t k√Ω ch·∫°y b·ªô (Online)</h2>

<div class="dayBar">
<span onclick="changeDay(-1)">‚óÄ</span>
<input type="date" id="runDate" onchange="loadDayData()">
<span onclick="changeDay(1)">‚ñ∂</span>
</div>

<input type="number" id="km" placeholder="S·ªë km">
<input type="number" id="minutes" placeholder="S·ªë ph√∫t ch·∫°y">
<button onclick="saveRun()">L∆∞u</button>

<button onclick="toggleSection('historyBox')">üìú Xem l·ªãch s·ª≠ ƒë√£ nh·∫≠p</button>
<div class="sectionBox sectionContent" id="historyBox"></div>

<div class="monthNav">
<span onclick="changeMonth(-1)">‚óÄ</span>
<span id="monthTitle"></span>
<span onclick="changeMonth(1)">‚ñ∂</span>
</div>

<div class="sectionBox">
<div class="sectionHeader" onclick="toggleSection('goalContent')">
<span>üéØ M·ª•c ti√™u th√°ng</span>
<span id="goalSummary">Ch∆∞a ƒë·∫∑t</span>
</div>
<div class="sectionContent" id="goalContent">
<input type="number" id="goalInput" placeholder="Nh·∫≠p m·ª•c ti√™u km">
<button onclick="saveGoal()">L∆∞u m·ª•c ti√™u</button>
<div id="goalProgress"></div>
<div class="progressBarWrap"><div class="progressBar" id="progressBar"></div></div>
</div>
</div>

<div class="sectionBox">
<div class="sectionHeader" onclick="toggleSection('chartContent')">
<span>üìä Bi·ªÉu ƒë·ªì th√°ng</span>
<span>·∫§n ƒë·ªÉ xem</span>
</div>
<div class="sectionContent" id="chartContent">
<canvas id="runChart"></canvas>
</div>
</div>

<div class="sectionBox">
<div class="sectionHeader" onclick="toggleSection('dotsContent')">
<span>üî• Chu·ªói th√°ng</span>
<span>·∫§n ƒë·ªÉ xem</span>
</div>
<div class="sectionContent" id="dotsContent">
<div class="dots" id="dots"></div>
<div class="dayDetail" id="detailBox">Ch·ªçn m·ªôt ng√†y ƒë·ªÉ xem chi ti·∫øt</div>
</div>
</div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getDatabase, ref, set, get, remove, child } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCgwqXrG0MzYZxWHmaNgcAE1h5HG0zNhSI",
  authDomain: "runm2026.firebaseapp.com",
  databaseURL: "https://runm2026-default-rtdb.firebaseio.com",
  projectId: "runm2026",
  storageBucket: "runm2026.firebasestorage.app",
  messagingSenderId: "353845948909",
  appId: "1:353845948909:web:b0d3c35408009119a7b7e4"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
const ALLOWED_EMAIL="15102002@gmail.com";

document.body.insertAdjacentHTML("afterbegin",`
<div id="loginBox" style="position:fixed;inset:0;background:#fff;display:flex;align-items:center;justify-content:center;z-index:9999">
<div style="background:white;padding:20px;border-radius:12px;box-shadow:0 10px 20px rgba(0,0,0,.2);width:280px">
<h3>ƒêƒÉng nh·∫≠p</h3>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Password">
<button id="loginBtn">Login</button>
<p id="loginMsg" style="color:red;font-size:13px"></p>
</div></div>`);

loginBtn.onclick=async()=>{try{await signInWithEmailAndPassword(auth,email.value,password.value);}catch{loginMsg.innerText="Sai t√†i kho·∫£n ho·∫∑c m·∫≠t kh·∫©u";}};
onAuthStateChanged(auth,user=>{if(user){if(user.email!==ALLOWED_EMAIL){alert("Kh√¥ng c√≥ quy·ªÅn");signOut(auth);return;}loginBox.style.display="none";loadAllRuns();}});

let currentMonth=new Date().getMonth();
let currentYear=new Date().getFullYear();
let allRuns={};let chart;
runDate.value=new Date().toISOString().split('T')[0];

function toggleSection(id){const el=document.getElementById(id);el.style.display=el.style.display==="none"?"block":"none";}
function changeDay(s){const d=new Date(runDate.value);d.setDate(d.getDate()+s);runDate.value=d.toISOString().split('T')[0];loadDayData();}
function changeMonth(s){currentMonth+=s;if(currentMonth<0){currentMonth=11;currentYear--;}if(currentMonth>11){currentMonth=0;currentYear++;}updateUI();}

async function saveRun(){await set(ref(db,'runs/'+runDate.value),{km:+km.value,minutes:+minutes.value});loadAllRuns();}
async function loadAllRuns(){const snap=await get(child(ref(db),'runs'));allRuns=snap.exists()?snap.val():{};updateUI();loadDayData();renderHistory();}
async function deleteRun(date){await remove(ref(db,'runs/'+date));loadAllRuns();}

function loadDayData(){const r=allRuns[runDate.value];km.value=r?r.km:"";minutes.value=r?r.minutes:"";}

function renderHistory(){
historyBox.innerHTML="";
Object.entries(allRuns).sort().reverse().forEach(([date,r])=>{
historyBox.innerHTML+=`<div class="historyItem">${date} - ${r.km}km - ${r.minutes}p <button class="deleteBtn" onclick="deleteRun('${date}')">X</button></div>`;
});
}

async function saveGoal(){await set(ref(db,'goals/'+currentYear+'-'+(currentMonth+1)),+goalInput.value);updateUI();}
async function getGoal(){const snap=await get(child(ref(db),'goals/'+currentYear+'-'+(currentMonth+1)));return snap.exists()?snap.val():0;}

async function updateUI(){
monthTitle.innerText=`Th√°ng ${currentMonth+1}/${currentYear}`;
const goal=await getGoal();
let total=0;
Object.entries(allRuns).forEach(([d,r])=>{if(d.startsWith(`${currentYear}-${String(currentMonth+1).padStart(2,'0')}`)) total+=r.km;});
goalSummary.innerText=goal?goal+" km":"Ch∆∞a ƒë·∫∑t";
progressBar.style.width=goal?Math.min(100,(total/goal)*100)+"%":"0%";
drawDots();drawChart();
}

function drawDots(){
dots.innerHTML="";
const days=new Date(currentYear,currentMonth+1,0).getDate();
for(let d=1;d<=days;d++){
const dateStr=`${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
const run=allRuns[dateStr];
const dayDot=document.createElement("div");dayDot.className="dayDot";
const dot=document.createElement("div");dot.className="dot";
if(run){dot.style.background="#000";dot.onclick=()=>detailBox.innerText=`üìÖ ${dateStr} ‚Äî ${run.km} km ‚Äî ${run.minutes} ph√∫t`;}
const num=document.createElement("div");num.className="dayNum";num.innerText=d;
dayDot.append(dot,num);dots.appendChild(dayDot);
}
}

function drawChart(){
const days=new Date(currentYear,currentMonth+1,0).getDate();
let labels=[],data=[];
for(let d=1;d<=days;d++){
const dateStr=`${currentYear}-${String(currentMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
labels.push(d);data.push(allRuns[dateStr]?allRuns[dateStr].km:0);
}
if(chart)chart.destroy();
chart=new Chart(runChart,{type:'bar',data:{labels,datasets:[{data,backgroundColor:'#4facfe'}]},options:{plugins:{legend:{display:false}}}});
}

window.deleteRun=deleteRun;
</script>
</body>
</html>
